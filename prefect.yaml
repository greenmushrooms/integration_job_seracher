name: integration-job-searcher
prefect-version: "3.0.0"
build: null
push: null

pull:
  - prefect.deployments.steps.git_clone:
      id: clone-step
      repository: https://github.com/greenmushrooms/integration_job_seracher.git
      branch: main
      include_submodules: true

  - prefect.deployments.steps.run_shell_script:
      id: install-deps
      directory: "{{ clone-step.directory }}"
      script: |
        git submodule update --init --recursive
        ls -la data__job_searcher/
      stream_output: true

deployments:
  - name: job-search-deployment
    version: "1.0.0"
    tags: ["jobs", "etl"]
    description: "Job search and processing flow"
    entrypoint: main.py:get_jobs
    parameters:
      title: "data engineer"
      location: "Toronto, ON"
      profile: "Slava"
      searches: 60
    schedule:
      cron: "0 7 * * *"
      timezone: "America/Toronto"
    work_pool:
      name: dev-pool-docker
      work_queue_name: default
      job_variables:
        image: "integration-job-searcher:latest"
        image_pull_policy: "Never"
        network_mode: "host"
        env:
          DB_HOST: "{{ prefect.blocks.secret.job-searcher--database-host }}"
          DB_PORT: "{{ prefect.blocks.secret.job-searcher--database-port }}"
          DB_USER: "{{ prefect.blocks.secret.job-searcher--database-user }}"
          DB_PASSWORD: "{{ prefect.blocks.secret.job-searcher--database-password }}"
          DB_NAME: "{{ prefect.blocks.secret.job-searcher--database-name }}"
          TELEGRAM_BOT_TOKEN: "{{ prefect.blocks.secret.job-searcher--telegram-bot-token }}"
          TELEGRAM_CHAT_ID: "{{ prefect.blocks.secret.job-searcher--telegram-chat-id }}"
